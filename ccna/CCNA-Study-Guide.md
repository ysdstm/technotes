## 第1章 网络互联

### 1.1 网络互联基础

> 描述了连接了集线器的主机怎样通讯

A主机192.168.0.2与B主机192.168.0.3位于同一Lan中，A主机需要与B主机通讯，A主机将发送一个链路层广播，广播的目标MAC地址为`ff:ff:ff:ff:ff:ff`，并发送一个IP Lan广播，目标地址为192.168.0.255，B主机响应后，将自己的IP地址及MAC地址发送给A主机。

导致LAN拥塞的常见原因：

- 同一个广播域活冲突域中的主机太多
- 广播风暴
- 组播数据流太多
- 带宽太低
- 使用集线器扩展网络

路由器的优点：

* 默认情况下，路由器不转发广播
* 路由器可根据第3层（网络层）信息（如IP地址）对网络进行过滤

路由器在网络中的功能：

* 分组交换
* 分组过滤
* 网络间通信
* 路径选择

> 路由器实际上是第3层交换机，使用逻辑地址，并提供分组交换功能，还可以使用访问列表进行分组过滤，用于组件互联网
>
> 而交换机用于转发和过滤帧，在交换型网络内的端口之间交换帧，用于提高Lan的功能，提供更高的带宽。

网桥、集线器、交换机、路由器的特点：

* 网桥用于分割冲突域


* 集线器的所有端口同属于一个冲突域和一个广播域
* 交换机的所有端口属于一个广播域，一个端口是一个冲突域（默认情况下）
* 路由器每个端口都属于不同的广播域

> > 考试要点：数网络中有多少个冲突域和广播域
> >
> > 技巧：路由器分割广播域，与路由器连接了几个交换网络，就有几个广播域和冲突域
> >
> > 交换机和网桥的每个端口连接一个冲突域
> >
> > 集线器连接的同属一个冲突域
> >
> > 因此：广播域个数=路由器使用的端口个数
> >
> > 冲突域个数=交换机使用的端口个数（交换机互联算1个）+网桥所使用的端口个数

### 1.2 网络互联模型

#### 1.2.1 分层方法

#### 1.2.2 参考模型的优点

OSI分层模型的优点：

* 将网络通信过程划分成更小、更简单的组件，这有助于组件的开发、设计和故障排除；
* 通过标准化网络组件，让多家厂家能够协作开发；
* 定义了模型每层执行的功能，从而鼓励了行业标准化；
* 让不同类型的网络硬件和软件能够彼此通信；
* 避免让对一层的修改影响其他层，从而避免妨碍开发工作。

### 1.3 OSI参考模型

OSI模型包含7层，分为两组：上3层指定了终端中的应用程序如何彼此通信以及如何与用户交流；下4层指定了如何进行端到端的数据传输。

功能概括：

* 应用层：提供用户界面
* 表示层：表示数据、进行加密处理
* 会话层：将不同应用程序的数据分离
* 传输层：提供逻辑地址、在重传前执行纠错
* 数据链路层：将分组拆分为字节，将字节组合成帧、使用MAC地址提供介质访问、执行错误检测但不纠错
* 物理层：在设备之间传输比特、指定电平 电缆速度和电缆针脚

下面的网络设备运行在OSI模型的全部7层上：

* NMS (Network Management Station) 网络管理工作站
* Web和应用程序服务器
* 网关（非默认网关）
* 网络主机

OSI模型各层的功能：

* 应用层：文件、打印、消息、数据库和应用程序服务
* 表示层：数据加密、压缩和转换服务
* 会话层：对话控制
* 传输层：端到端连接
* 网络层：路由选择
* 数据链路层：成帧
* 物理层：物理拓扑

#### 1.3.1 应用层

应用层是用户与计算机交流的场所，仅当马上需要访问网络时，这一层才发挥作用。

应用层还负责确定目标通信方的可用性，并判断是否有足够的资源进行想要的通信。

> 应用层是实际应用程序之间的接口。例如Word并不位于应用层中，而是与应用层协议交互。位于应用层中的程序有FTP和TFTP。

#### 1.3.2 表示层

表示层向应用层提供数据，并负责数据转换和代码格式化。

将数据转换为标准格式再进行传输。例如从EDCDIC转换为ASCII。

通过提供转换服务，表示层能够确保从一个系统的应用层传输而来的数据被另一个系统的应用层读取。

OSI制定了相关的协议标准，这些标准定义了如何格式化标准数据。诸如数据压缩、解压缩、加密和解密等。

#### 1.3.3 会话层

会话层负责再表示层尸体之间建立、管理和终止会话，对设备或节点之间的对话进行控制。

协调和组织系统之间的通信，提供了3种模式：单工、半双工和全双工。

会话层的基本功能是将不同应用程序的数据分离。

#### 1.3.4 传输层

传输层将数据进行分段并重组为数据流。

位于传输层的服务将来自上层应用的数据进行分段和重组，并将它们合并到同一个数据流中。

提供端到端的数据传输服务，并可再互联网络上的发送主机和目标主机之间建立逻辑连接。

TCP提供可靠的服务，而UDP不是。

##### 1.流量控制

流量控制可避免作为发送方的主机让作为接收方的主机的缓冲区溢出，避免数据丢失。

可靠的数据传输TCP在系统之间使用面向连接的通信会话，涉及的协议确保可实现如下目标：

* 收到数据段后，向发送方进行确认；
* 重传所有未得到确认的数据段；
* 数据段到达目的地后，按正确的顺序排列它们；
* 确保数据流量不超过处理能力，以避免拥塞、过载和数据丢失。

##### 2.面向连接的通信

在可靠的传输过程中，首先需要与远程设备建立通信会话，称为呼叫建立或`三次握手`，数据传输完毕后，将进行呼叫终止，以拆除虚电路。

传输信息期间，两台主机定期检查对方，通过协议软件进行通信，确保进展顺利并且正确地收到了数据。

三次握手的步骤：

* 发送方先发送SYN“连接协定”数据段，用于请求同步
* 接收方返回SYN/ACK数据段，用于确认请求，并在主机之间确定连接参数，这些数据段也也请求同步接收方的排序，以建立双向连接
* 发送方发送ACK数据段给接收方，最后一个数据段也用来进行确认，它通知目标主机连接协定已被接受且连接以建立。双方可以传输数据了。

面向连接的服务有以下特征：

* 建立虚电路（三次握手）
* 使用排序技术
* 使用确认
* 使用流量控制

##### 3.窗口技术

如果传输方发送每个数据段后都必须等待确认，传输速度将变得缓慢，一次发送多个数据段，才需要一次确认，将提高传输效率。

在收到确认前，传输方可发送的数据段数量（以字节为单位）成为窗口。

> 窗口用于控制未确认的数据段数量。如果未接收到所有应确认的字节，接收方将缩小窗口，以改善通信会话。

##### 4.确认

可靠的数据传输依靠功能完整的数据链路，从而确保机器之间发送的数据流的完整性，确保数据不会重复或丢失。

通过肯定确认和重传方法，要求接收方在收到数据后向发送方发送一条确认信息。

确认：发送方记录每个以字节为单位度量的数据段，将其发送后等待确认，而暂不发送下一数据段。

重传：发送数据段后，发送方启动定时器，如果定时器到期后任未收到对方确认，将重传该数据段。

#### 1.3.5 网络层

网络层管理设备编址、跟踪设备在网络中的位置并确定最佳的数据传输路径。

路由器位于网络层，在互联网络中提供路由选择服务。

网络层转发数据过程如下：

1.在一个接口上收到分组后，路由器先检查分组的`目标IP地址`

2.如果分组的目的地不是当前路由器，将在路由选择表中查找目标网络地址，并发送到连接目标网络的接口

3.如果找不到目标网络，路由器将丢弃分组

在网络层，使用的分组有两种：数据和路由更新

* **数据分组** 用于在互联网络中传输用户数据。用于支持用户数据的协议成为`被路由协议`
* **路由更新分组** 包含有关互联网中所有路由器连接的网络的更新信息，用于将这些信息告知相邻路由器。发送路由更新分组的协议称为`路由选择协议`，常见的有RIP，RIPv2，EIGRO，OSPF等。路由更新分组用于帮助每台路由器建立和维护路由选择表。

路由器使用的路由选择表包含以下信息：

* 网络地址
* 接口
* 度量值 不同的路由选择协议使用不同的方法计算度量值。

关于路由器，需要牢记的以下几点：

1. 默认情况下，路由器不会转发任何广播分组和组播分组。
2. 路由器根据网络层报头中的逻辑地址决定将分组转发到哪个下一跳路由器。
3. 路由器可使用管理员创建的访问控制列表控制可进出接口的分组类型，以提高安全性。
4. 必要时，路由器可在同一个接口提供第二层桥接功能和路由功能（子接口）。
5. 第3层设备（路由器）在虚拟LAN(VLAN)之间提供连接。
6. 路由器可为特定网络类型的数据提供QoS(Quality of Service，服务质量)。

#### 1.3.6 数据链路层

数据链路层提供数据的物理传输，并处理错误通知、网络拓扑和流量控制。

数据链路层通过使用硬件地址来在LAN中传输报文，将来自网络层的报文转换为比特，供物理层传输。

数据链路层将报文封装成`数据帧`，并添加定制的报头，其中包含`目标硬件地址`和`源硬件地址`。

数据分组是如何通过路由器到达本地网络的：

当数据分组经过路由器时，路由器将剥离数据链路层在报文上添加的报头信息，只保留完整的原始数据分组。

IEEE以太网数据链路层包含两个子层，如下：

* 介质访问控制（MAC）子层（802.3） 定义了如何通过介质传输分组。
* 逻辑链路控制（LLC）子层（802.2） 负责识别网络层协议并对其封装。

工作在数据链路层的交换机和网桥：

第2层交换是基于硬件的桥接，使用了称为ASIC（Application-specific Intergrated Circuit，专用集成电路）的特殊硬件。ASIC的速度可高达GBit，且延迟非常低。

> 这里的延迟指的是从帧进入端口到离开端口之间的时间。

网桥和交换机读取通过网络传输的帧，当帧进入交换机端口时，第2层设备将帧的源硬件地址（MAC地址）加入过滤表中。

建立过滤表后，第2层设备将只把帧发送到目标硬件地址所属的网段：

如果目标设备与发送设备位于同一网段，则将禁止帧进入其他网段；

如果位于另一网段，则将只传输到该网段。

如果在过滤表中找不到目标硬件地址，将把帧转发给所有网段（广播），如果有未知设备对转发操作做出应答，交换机将更新过滤表中有关该设备位置的信息；

如果帧的目标地址为广播地址，交换机将默认把所有广播转发给与之相连的所有网段。

使用集线器时，由于所有端口在一个冲突域中，每个网段中不能有多台设备同时通信。

#### 1.3.7 物理层

物理层发送和接受比特Bit。

物理层定义了要在终端系统之间激活、维护和断开物理链路，而需要满足的电气、机械、规程和功能要求，还能够让你确认DTE（Data Terminal Equipment，数据终端设备）和DCE（Data Communication Equipment，数据通信设备）之间的接口。

DCE通常位于服务提供商处，DTE是与之相连的设备。

工作在物理层的集线器

集线器是一种多端口转发器。转发器接收数字信号，进行放大活重建，然后通过所有活动端口转发出去。

与集线器相连的所有设备必须侦听，查看是否有其他设备在传输数据。

### 1.4 小结

### 1.5 考试要点

- 找出可能导致LAN拥塞的原因。

广播域中的主机太多、广播风暴、组播以及带宽太低都是导致LAN拥塞的可能原因。

- 描述冲突域与广播域的区别。

在同一冲突域中，一台设备发送分组时，该网段中的其他设备必须侦听它。

在同一广播域中，网段中的所有设备都侦听在该网段中发送的广播。

- 区分MAC地址和IP地址，描述在网络中使用这些地址的时机和方式。
- 理解集线器、网桥、交换机和路由器的区别。
- 了解路由器的功能和特点。
- 区分面向连接的网络服务和无连接网络服务，描述网络通信期间如何处理这两种服务。
- 定义OSI模型的各层，了解每层的功能，描述各种设备和网络协议所属的层。





### 名词解释

* OSI (Open Systems Interconnection) 开放系统互联

* ARP (Address Resolution Protocol) 地址解析协议

* Network Segmentation 网络分段

* Boradcast domain 广播域

* Collision domain 冲突域

* ISO (International Organization for Standardization) 国际标准化组织

* DTE (Data Terminal Equipment) 数据终端设备

* DCE (Data Communication Equipment) 数据通信设备

  ​