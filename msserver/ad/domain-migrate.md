#### 域迁移

需要做域迁移的情况有以下几种：  

* 域控制器系统升级
* 域控制器服务器更换

> 以上两种称为域控制器转移，简要概括过程为：

    1. 添加额外域控制器，复制主域控制器信息，
    2. 配置DNS，复制主域控制器DNS信息，
    3. 在额外域控制器上删除主域控制器，
    4. 主域控制器降域，额外域控制器夺权，
    5. 客户端修改IP指向额外预控，或者修改额外域控制器地址为原主域控制器地址。


* 不同组织合并，多个域合并为一个域
* 同一组织服务器分离，一个域分离为多个域

> 以上两种是跨域迁移用户及计算机

#### 使用ADMT工具跨域迁移用户和计算机

> 谈到创建全新的域，在用户数不多的情况下，可能最先想到的是：

    1. 创建新域控制器，
    2. 记录下原来的用户帐号信息，组信息，重新创建用户和组，
    3. 文件服务器配置新域用户权限
    4. 与原来的域做信任关系，
    5. 逐步将现有计算机退域，重新加入新域
    6. 全部完成后，将文件服务器旧用户权限删除

此种做法最麻烦的是第2步，和第5步，第2步需要谨慎，不能有疏漏，否则用户不能正常访问共享文件，第5步，用户需要重新配置密码和用户环境，旧用户数据需要迁移，例如桌面文件，收藏夹，邮箱还要重新配置，当然这与域迁移无关，只要重新加入新域，系统一定会创建新的用户配置文件，可以通过工具迁移。  
在公司环境中，普通用户使用的软件比较单一，Office，邮箱等等，技术部门使用的设计软件多一些，但也要考虑到同事，部门经理，总经理的感受，会耽误时间，有疏漏还要多次返工。  
做IT遇到事情就要重新来过，那不是称职的IT吧，IT应该把大把的时间花在平时的修炼上，解决问题必须快速。要对当前公司和岗位需要用到的技术提前预估，提前修炼。  

废话不多说，记录一下此次域用户迁移的模拟演练过程，花了将近1整天的时间。  

##### 背景及步骤概括

目前公司用的是公司总部的域，总部以及分部使用了4个域控制器，此次需要建立独立的域控，文件服务器的权限也要迁移，用户数量50左右。  
服务器操作系统比较老，Windows Server 2008，非R2，另外有一台DHCP服务器，打算用它来做新的域控，暂时保留原域控制器。  

1. 建立DNS辅助区域 或 建立条件转发
 > 在模拟过程中，建立辅助域后，能双方能解析对方的域，但无法建立信任域，不加.local到最后一步失败，加.local第一步就无法通过，提示`“您指定的名称不是有效的Windows域名称。指定的名称是一个Kerberos V5领域吗？”`
2. 提升域控制器和林级别
3. 创建林/域信任
4. 在新域控上安装ADMT迁移工具
 > ADMT从3.0到3.2三个版本，分别对应最高为2003,2008,2008R2的服务，3.2只有64位版本，但此次的2008为32位版本，3.1官方不再提供，好不容易才下载到英文版
5. 在旧域控上安装PES(Password Export Server)，也叫pwdimg工具
6. 迁移用户
7. 迁移计算机

##### 建立双向DNS解析，建立DNS辅助区域方式 或 建立条件转发器

> 用文字代替截图，标识约定：

	[窗口标题]  
	[-] 选中的选项  

###### 1. 建立DNS辅助区域方式

两个域控都要建立  

####### 建立区域复制信任

打开DNS管理器，或者运行dnsmgmt.msc  
正向查找域->本地域名，右键打开[本地域名 属性]，打开 区域传送 标签页  

	[本地域名 属性]
	[[区域传送]]
	[-] 允许区域传送
	[-] 只允许到下列服务器
	添加对方域控IP地址  

另一域控重复步骤

####### 建立辅助区域

右键点击DNS服务器，选择新建区域  

	[新建区域向导]
	选择您要创建的区域的类型：
	[-] 辅助区域
	下一步
	[-] 正向查找域
	下一步
	= 对方域名.local
	下一步
	= 对方域控IP地址
	
另一域控重复步骤，检查是否已复制另一个域的DNS信息

###### 或 

###### 1. 建立条件转发器

打开DNS管理器，右键点击条件转发器，选择[新建条件转发器]

	[新建条件转发器]
	= 对方DNS域，对方域名.local
	= 对方DNS服务器IP地址
	其他默认
	
另一域控重复步骤

###### 2.提升域控制器级别

打开Active Directory域和信任关系，或者运行domain.msc  

右击Active Directory域和信任关系，选择[提升林功能级别]  

	[提升林功能级别]
	选择Windows Server 2008

右击域名称，选择[提升域功能级别]  

	[提升域功能级别]
	选择Windows Server 2008

###### 3. 创建林信任

右击域名称，选择[属性]  

	[域 属性]
	[[信任]]标签页
	点击 新建信任

进入向导

	[新建信任向导]
	下一步
	= 对方域名.local
	下一步
	[-] 林信任
	下一步
	[-] 双向
	下一步
	[-] 这个域和指定的域
	下一步
	[-] 用户名 = 对方域名\administrator
	[-] 密码  = 域管理员密码
	下一步
	[-] 全林性身份验证
	下一步
	[-] 全林性身份验证
	下一步
	提示 您选择了下列信任设置
	下一步
	[-] 是，确认传出信任
	下一步
	[-] 是，确认传入信任
	下一步
	点击 完成
	
查看双方服务器，检查是否已经建立信任。

####### 检查域dcdiag

DFSREvent Error

打开 服务器管理器 -> 诊断 -> 事件查看器 -> 应用程序和服务日志 -> DFS Replication 清除日志

再次 dcdiag

###### 4. 在目标域控上安装ADMT迁移工具
	
	[Active Directory 迁移工具安装向导]
	打开安装程序，下一步
	[-] 使用Mcirosoft SQL Server 2005 Express (Windows)
	本以为要额外装数据库，其实不用
	下一步
	[-] 否，不要从ADMTv3导入数据
	完成
	
###### 5. 在源域控安装pwdmig工具

在**目标域控**上cmd执行
	
	admt key /option:create /sourcedomain:源域控 /keyfile:c:\源域控.pes /keypassword:key密码

将生成的acn.pes拷贝到源域控上

在**源域控**上，安装pwdmig工具，下一步

	[ADMT 密码迁移 DLL安装程序]
	选择加密文件
	下一步
	密码 = key密码
	下一步
	[-] 登录身份 = 本地域管理员帐号
	密码 = 本地域管理员密码
	完成

重启服务器

###### 6. 将对方的domain admins 组添加到本地 administrators组 中

打开Active Directory 用户和计算机

	Builtin -> Administrators
	[Administrators 属性]
	[[成员]]标签页
	添加对方域Domain Admins组


另一域控重复步骤

###### 7. 迁移用户

启动源域控 服务 -> 密码导出服务器服务

在目标域控运行migrator.msc，打开迁移工具

右键点击Active Directory迁移工具，选择用户账户迁移向导

菜单为：

	用户账户迁移向导
	组账户迁移向导
	计算机迁移向导
	安全性转换向导
	报告向导
	服务账户迁移向导
	Exchange 5.5 邮箱转换向导
	重试人任务向导
	密码迁移向导

点击下一步

	[用户账户迁移向导]
	源
	域 = 源域名.local
	域控制器 = 选择源域控制器
	目标
	域 = 目标域名.local
	域控制器 = 选择目标域控制器
	下一步
	[-] 从域中选择用户
	下一步
	添加要迁移的用户
	下一步
	点击浏览，选择目标OU组织单位
	下一步
	[-] 迁移密码
	[-] [ ] 不更新现有密码
	下一步
	[-] 目标与源相同
	[-] 将用户SID迁移至目标域
	下一步
	[-] 修复用户的组员身份
	下一步
	对象属性排除
	保持默认
	下一步
	[-] 在目标...不迁移源对象
	完成
	点击 查看日志
	检查帐号是否已复制

####### 8. 迁移计算机

	大部分都与迁移用户一样
	[-] 用户配置文件
	[-] 用户权利
	
	[-] 添加
	
	完成后，检查是否迁移成功


####### 用户配置文件迁移

下载`https://www.forensit.com/downloads.html`  

本地管理员登录下执行，选择配置文件，下一步，输入要加入的域，输入用户帐号名称，点击下一步，重启，登录  


